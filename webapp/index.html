<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save Manager</title>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Saves</h2>
            <button id="newSave">+</button>
        </div>
        <div class="save-list" id="saveList"></div>
    </div>
    <div class="content">
        <div class="content-header">
            <input type="text" id="saveTitle" placeholder="Save title" style="display: none;">
            <div class="btn-group">
                <button id="saveButton" style="display: none;">Save</button>
                <button id="deleteButton" class="delete" style="display: none;">Delete</button>
            </div>
        </div>
        <textarea id="saveContent" class="save-content" placeholder="Select or create a save..." style="display: none;"></textarea>
    </div>
    <div class="modal" id="newSaveModal">
        <div class="modal-content">
            <h3>New Save</h3>
            <input type="text" id="newSaveTitle" placeholder="Enter save title">
            <div class="btn-group">
                <button id="cancelSave">Cancel</button>
                <button id="createSave">Create</button>
            </div>
        </div>
    </div>
    <script type="module" src="/src/main.ts">
        // Save Manager class to handle localStorage operations
        class SaveManager {
            constructor() {
                this.STORAGE_KEY = 'webapp_saves';
                this.currentSave = null;
                this.setupListeners();
                this.loadSaves();
            }

            setupListeners() {
                // New save button
                document.getElementById('newSave').addEventListener('click', () => {
                    document.getElementById('newSaveModal').classList.add('show');
                    document.getElementById('newSaveTitle').focus();
                });

                // Create save
                document.getElementById('createSave').addEventListener('click', () => this.createNewSave());
                document.getElementById('cancelSave').addEventListener('click', () => {
                    document.getElementById('newSaveModal').classList.remove('show');
                    document.getElementById('newSaveTitle').value = '';
                });

                // Save changes
                document.getElementById('saveButton').addEventListener('click', () => this.saveChanges());

                // Delete save
                document.getElementById('deleteButton').addEventListener('click', () => this.deleteSave());

                // Auto-save on title change
                document.getElementById('saveTitle').addEventListener('change', () => this.saveChanges());
            }

            getSaves() {
                try {
                    return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
                } catch {
                    return [];
                }
            }

            saveToPersistence(saves) {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(saves));
            }

            loadSaves() {
                const saves = this.getSaves();
                const saveList = document.getElementById('saveList');
                saveList.innerHTML = '';

                saves.forEach(save => {
                    const item = document.createElement('div');
                    item.className = 'save-item';
                    if (this.currentSave && this.currentSave.id === save.id) {
                        item.classList.add('active');
                    }
                    item.textContent = save.title;
                    item.addEventListener('click', () => this.loadSave(save));
                    saveList.appendChild(item);
                });
            }

            createNewSave() {
                const titleInput = document.getElementById('newSaveTitle');
                const title = titleInput.value.trim();
                if (!title) return;

                const save = {
                    id: Date.now().toString(),
                    title,
                    content: '',
                    created: Date.now(),
                    updated: Date.now()
                };

                const saves = this.getSaves();
                saves.unshift(save);
                this.saveToPersistence(saves);
                this.loadSaves();
                this.loadSave(save);

                // Reset and hide modal
                titleInput.value = '';
                document.getElementById('newSaveModal').classList.remove('show');
            }

            loadSave(save) {
                this.currentSave = save;
                const titleInput = document.getElementById('saveTitle');
                const contentArea = document.getElementById('saveContent');
                const saveButton = document.getElementById('saveButton');
                const deleteButton = document.getElementById('deleteButton');

                titleInput.style.display = 'block';
                contentArea.style.display = 'block';
                saveButton.style.display = 'block';
                deleteButton.style.display = 'block';

                titleInput.value = save.title;
                contentArea.value = save.content;
                this.loadSaves(); // Refresh list to update active state
            }

            saveChanges() {
                if (!this.currentSave) return;

                const saves = this.getSaves();
                const index = saves.findIndex(s => s.id === this.currentSave.id);
                if (index === -1) return;

                saves[index] = {
                    ...this.currentSave,
                    title: document.getElementById('saveTitle').value,
                    content: document.getElementById('saveContent').value,
                    updated: Date.now()
                };

                this.currentSave = saves[index];
                this.saveToPersistence(saves);
                this.loadSaves();
            }

            deleteSave() {
                if (!this.currentSave || !confirm('Are you sure you want to delete this save?')) return;

                let saves = this.getSaves();
                saves = saves.filter(s => s.id !== this.currentSave.id);
                this.saveToPersistence(saves);
                this.currentSave = null;

                // Hide editors
                document.getElementById('saveTitle').style.display = 'none';
                document.getElementById('saveContent').style.display = 'none';
                document.getElementById('saveButton').style.display = 'none';
                document.getElementById('deleteButton').style.display = 'none';

                this.loadSaves();
            }
        }

        // Initialize the save manager
        new SaveManager();
    </script>
</body>
</html>